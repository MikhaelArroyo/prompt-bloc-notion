<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Découvrez des idées de prompts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }

        /* --- Custom Select --- */
        .select-arrow {
            transition: transform 0.3s ease;
        }
        .select-arrow-up {
            transform: rotate(180deg);
        }

        /* --- Loading Text Animation --- */
        #loading-text {
            transition: opacity 0.5s ease-in-out;
        }
        #loading-text.is-fading {
            opacity: 0;
        }
        
        #history-panel {
            /* On positionne la liste par rapport à son parent, #main-panel */
            position: absolute;
            /* Aligne parfaitement la liste SOUS le texte du déclencheur */
            top: 4.5rem; 
            /* Aligne la gauche de la liste à 1rem de la bordure droite du panneau principal */
            left: calc(100% + 2rem); 
            width: 50%;
            /* État initial pour l'animation (caché) */
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            /* Transition douce pour l'apparition */
            transition: max-height 0.6s ease-in-out, opacity 0.5s ease-in-out;
        }

        /* On conserve le décalage du panneau principal */
        body.history-open #main-panel {
            transform: translateX(-150px);
        }

        /* État final pour l'animation (visible) */
        body.history-open #history-panel {
            opacity: 1;
            max-height: 80vh;
        }

        /* --- Custom Scrollbar --- */
        #history-list {
            overflow-y: hidden; /* Hide scrollbar by default */
        }
        #history-panel.history-expanded #history-list {
            overflow-y: auto; /* Show scrollbar only when expanded */
        }
        #history-list::-webkit-scrollbar-button {
            display: none; /* Hide scrollbar arrows */
        }
        #history-list::-webkit-scrollbar {
            width: 8px;
        }
        #history-list::-webkit-scrollbar-track {
            background: transparent;
        }
        #history-list::-webkit-scrollbar-thumb {
            background: #010132;
            border-radius: 10px;
        }
        #history-list {
           scrollbar-width: thin;
           scrollbar-color: #010132 transparent;
        }

        /* Animation de la flèche */
        body.history-open #history-arrow {
            transform: rotate(-90deg);
        }
        
        /* [NOUVEAU] Animation de la flèche pour "Voir plus" */
        #history-panel.history-expanded #see-more-arrow {
            transform: rotate(180deg);
        }
        
        #prompt-loading {
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        #prompt-loading.is-visible {
            opacity: 1;
        }

        /* --- Animation: Typewriter --- */
        .typewriter-loader {
            --blue: #5C86FF;
            --blue-dark: #275EFE;
            --key: #fff;
            --paper: #EEF0FD;
            --text: #D3D4EC;
            --tool: #FBC56C;
            --duration: 3s;
            position: relative;
            -webkit-animation: bounce05 var(--duration) linear infinite;
            animation: bounce05 var(--duration) linear infinite;
        }

        .typewriter-loader .slide {
            width: 92px;
            height: 20px;
            border-radius: 3px;
            margin-left: 14px;
            transform: translateX(14px);
            background: linear-gradient(var(--blue), var(--blue-dark));
            -webkit-animation: slide05 var(--duration) ease infinite;
            animation: slide05 var(--duration) ease infinite;
        }

        .typewriter-loader .slide:before, .typewriter-loader .slide:after,
        .typewriter-loader .slide i:before {
            content: "";
            position: absolute;
            background: var(--tool);
        }

        .typewriter-loader .slide:before {
            width: 2px;
            height: 8px;
            top: 6px;
            left: 100%;
        }

        .typewriter-loader .slide:after {
            left: 94px;
            top: 3px;
            height: 14px;
            width: 6px;
            border-radius: 3px;
        }

        .typewriter-loader .slide i {
            display: block;
            position: absolute;
            right: 100%;
            width: 6px;
            height: 4px;
            top: 4px;
            background: var(--tool);
        }

        .typewriter-loader .slide i:before {
            right: 100%;
            top: -2px;
            width: 4px;
            border-radius: 2px;
            height: 14px;
        }

        .typewriter-loader .paper {
            position: absolute;
            left: 24px;
            top: -26px;
            width: 40px;
            height: 46px;
            border-radius: 5px;
            background: var(--paper);
            transform: translateY(46px);
            -webkit-animation: paper05 var(--duration) linear infinite;
            animation: paper05 var(--duration) linear infinite;
        }

        .typewriter-loader .paper:before {
            content: "";
            position: absolute;
            left: 6px;
            right: 6px;
            top: 7px;
            border-radius: 2px;
            height: 4px;
            transform: scaleY(0.8);
            background: var(--text);
            box-shadow: 0 12px 0 var(--text), 0 24px 0 var(--text), 0 36px 0 var(--text);
        }

        .typewriter-loader .keyboard {
            width: 120px;
            height: 56px;
            margin-top: -10px;
            z-index: 1;
            position: relative;
        }

        .typewriter-loader .keyboard:before, .typewriter-loader .keyboard:after {
            content: "";
            position: absolute;
        }

        .typewriter-loader .keyboard:before {
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 7px;
            background: linear-gradient(135deg, var(--blue), var(--blue-dark));
            transform: perspective(10px) rotateX(2deg);
            transform-origin: 50% 100%;
        }

        .typewriter-loader .keyboard:after {
            left: 2px;
            top: 25px;
            width: 11px;
            height: 4px;
            border-radius: 2px;
            box-shadow: 15px 0 0 var(--key), 30px 0 0 var(--key), 45px 0 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 10px 0 var(--key), 37px 10px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 10px 0 var(--key);
            -webkit-animation: keyboard05 var(--duration) linear infinite;
            animation: keyboard05 var(--duration) linear infinite;
        }
        
        .custom-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #cbd5e1; /* border-slate-300 */
            border-radius: 0.5rem; /* rounded-lg */
            background-color: transparent;
            font-weight: 600; /* semibold */
            color: #475569; /* text-slate-600 */
            transition: all 0.2s ease-in-out;
        }
        .custom-btn:hover {
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        .custom-btn.active {
            background-color: #010132;
            color: white;
            border-color: #010132;
        }

        .loading-dots span {
            animation: blink 1.4s infinite both;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce05 {
            85%, 92%, 100% {
                transform: translateY(0);
            }

            89% {
                transform: translateY(-4px);
            }

            95% {
                transform: translateY(2px);
            }
        }

        @keyframes slide05 {
            5% {
                transform: translateX(14px);
            }

            15%, 30% {
                transform: translateX(6px);
            }

            40%, 55% {
                transform: translateX(0);
            }

            65%, 70% {
                transform: translateX(-4px);
            }

            80%, 89% {
                transform: translateX(-12px);
            }

            100% {
                transform: translateX(14px);
            }
        }

        @keyframes paper05 {
            5% {
                transform: translateY(46px);
            }

            20%, 30% {
                transform: translateY(34px);
            }

            40%, 55% {
                transform: translateY(22px);
            }

            65%, 70% {
                transform: translateY(10px);
            }

            80%, 85% {
                transform: translateY(0);
            }

            92%, 100% {
                transform: translateY(46px);
            }
        }

        @keyframes keyboard05 {
            5%, 12%, 21%, 30%, 39%, 48%, 57%, 66%, 75%, 84% {
                box-shadow: 15px 0 0 var(--key), 30px 0 0 var(--key), 45px 0 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 10px 0 var(--key), 37px 10px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 10px 0 var(--key);
            }

            9% {
                box-shadow: 15px 2px 0 var(--key), 30px 0 0 var(--key), 45px 0 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 10px 0 var(--key), 37px 10px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 10px 0 var(--key);
            }

            18% {
                box-shadow: 15px 0 0 var(--key), 30px 0 0 var(--key), 45px 0 0 var(--key), 60px 2px 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 10px 0 var(--key), 37px 10px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 10px 0 var(--key);
            }

            27% {
                box-shadow: 15px 0 0 var(--key), 30px 0 0 var(--key), 45px 0 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 12px 0 var(--key), 37px 10px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 10px 0 var(--key);
            }

            36% {
                box-shadow: 15px 0 0 var(--key), 30px 0 0 var(--key), 45px 0 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 10px 0 var(--key), 37px 10px 0 var(--key), 52px 12px 0 var(--key), 60px 12px 0 var(--key), 68px 12px 0 var(--key), 83px 10px 0 var(--key);
            }

            45% {
                box-shadow: 15px 0 0 var(--key), 30px 0 0 var(--key), 45px 0 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 2px 0 var(--key), 22px 10px 0 var(--key), 37px 10px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 10px 0 var(--key);
            }

            54% {
                box-shadow: 15px 0 0 var(--key), 30px 2px 0 var(--key), 45px 0 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 10px 0 var(--key), 37px 10px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 10px 0 var(--key);
            }

            63% {
                box-shadow: 15px 0 0 var(--key), 30px 0 0 var(--key), 45px 0 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 10px 0 var(--key), 37px 10px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 12px 0 var(--key);
            }

            72% {
                box-shadow: 15px 0 0 var(--key), 30px 0 0 var(--key), 45px 2px 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 10px 0 var(--key), 37px 10px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 10px 0 var(--key);
            }

            81% {
                box-shadow: 15px 0 0 var(--key), 30px 0 0 var(--key), 45px 0 0 var(--key), 60px 0 0 var(--key), 75px 0 0 var(--key), 90px 0 0 var(--key), 22px 10px 0 var(--key), 37px 12px 0 var(--key), 52px 10px 0 var(--key), 60px 10px 0 var(--key), 68px 10px 0 var(--key), 83px 10px 0 var(--key);
            }
        }

        @keyframes blink {
            0% {
                opacity: .2;
            }
            20% {
                opacity: 1;
            }
            100% {
                opacity: .2;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">
        <div class="flex-grow">
        <div class="container mx-auto px-6 py-12">
            <div class="relative">
                <div id="main-panel" class="md:w-2/3 mx-auto relative transition-transform duration-700 ease-in-out">
                    <div class="bg-white p-8 rounded-2xl shadow-lg flex flex-col">
                        <h2 class="text-3xl font-bold text-[#010132] text-center mb-8">Découvrez des idées de prompts</h2>
                        <div class="flex-grow">
                            <p class="text-slate-600 mb-6">Sélectionnez une tâche pour obtenir un prompt adapté que vous pourriez utiliser avec un outil d'IA.</p>
                            <div class="relative" id="custom-select-container">
                                <div id="select-selected" class="w-full p-3 border border-slate-300 rounded-lg mb transition-all duration-300 flex justify-between items-center cursor-pointer">
                                    <span id="select-text">Sélectionnez une tâche...</span>
                                    <svg id="select-arrow" class="select-arrow w-5 h-5 text-slate-500" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                </div>
                                <div id="select-options" class="hidden absolute top-full left-0 right-0 bg-white border border-t-0 border-slate-300 rounded-b-lg shadow-lg z-10 overflow-hidden"></div>
                            </div>
                            <p class="text-center text-slate-500 my-4">ou</p>
                            <div class="relative mb-8 flex items-center">
                                <input type="text" id="custom-task-input" placeholder="Entrez une tâche personnalisée ici..." class="w-full p-3 border border-slate-300 rounded-lg transition-all duration-300 focus:border-[#010132] focus:ring-1 focus:ring-[#010132]">
                                <button id="inspire-me-btn" class="custom-btn text-sm px-3 flex-shrink-0 ml-6" style="padding-top: 0.875rem; padding-bottom: 0.875rem; font-weight: 600;">J'ai besoin d'inspiration</button>
                            </div>
                        </div>
                        <div id="customization-options" class="space-y-6 mb-8">
                            <div>
                                <label class="block text-slate-700 font-bold mb-2">🎨 Ton</label>
                                <div id="tone-options" class="flex flex-wrap gap-2">
                                    <button data-value="Professionnel" class="custom-btn">Professionnel</button>
                                    <button data-value="Amical" class="custom-btn">Amical</button>
                                    <button data-value="Créatif" class="custom-btn">Créatif</button>
                                    <button data-value="Urgent" class="custom-btn">Urgent</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-slate-700 font-bold mb-2">📊 Niveau de détail</label>
                                <div id="detail-options" class="flex flex-wrap gap-2">
                                    <button data-value="Concise" class="custom-btn">Concise</button>
                                    <button data-value="Standard" class="custom-btn active">Standard</button>
                                    <button data-value="Très détaillé" class="custom-btn">Très détaillé</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <button id="generate-prompt-btn" class="w-full bg-[#49b048] hover:bg-[#3f993e] text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 disabled:bg-slate-400 flex items-center justify-center" disabled>
                                <span id="btn-text">Générer un prompt</span>
                                <span id="btn-emoji" class="hidden ml-2"> ✨</span>
                                <svg id="btn-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                            <div id="prompt-output" class="mt-8 p-4 bg-slate-100 rounded-lg text-slate-800 hidden"></div>
                            <button id="copy-btn" class="mt-8 w-full bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 px-4 rounded-lg hidden">Copier le prompt</button>
                            <div id="prompt-loading" class="mt-8 text-center hidden">
                                <div class="flex justify-center items-center py-8">
                                    <div class="typewriter-loader">
                                        <div class="slide"><i></i></div>
                                        <div class="paper"></div>
                                        <div class="keyboard"></div>
                                    </div>
                                </div>
                                <p id="loading-text" class="text-[#010132] font-semibold">Rédaction en cours...</p>
                            </div>
                        </div>
                    </div>
                        <div id="history-trigger" class="absolute top-8 -right-4 translate-x-full pl-4 cursor-pointer group">
                            <h3 class="text-lg font-bold text-slate-500 group-hover:text-[#010132] transition-colors whitespace-nowrap">
                            Historique récent <span id="history-arrow" class="inline-block transition-transform duration-300">→</span>
                            </h3>
                        </div>
                        <div id="history-panel" class="flex flex-col">
                            <div id="history-list" class="flex-grow space-y-2 max-h-[calc(80vh-8rem)] pr-2">
                            </div>
                            <div id="see-more-trigger" class="hidden cursor-pointer group pt-3 mt-3 border-t border-slate-200">
                                <h3 class="text-md font-bold text-slate-500 group-hover:text-[#010132] transition-colors">
                                    <span id="see-more-text">Voir plus</span>
                                    <span id="see-more-arrow" class="inline-block align-middle transition-transform duration-300">↓</span>
                                </h3>
                            </div>
                            <div id="export-history-container" class="pt-3 mt-auto hidden">
                                <button id="export-history-btn" class="w-full custom-btn text-sm" style="padding-top: 0.875rem; padding-bottom: 0.875rem;">Exporter l'historique (.txt)</button>
                            </div>
                        </div>
                </div>
            </div>      
        </div>
    </div>
    <footer class="py-8">
        <div class="container mx-auto px-6 text-center">
            <a href="https://lapuce.org" target="_blank" rel="noopener noreferrer" class="inline-block">
                <img src="https://lapuce.org/new/wp-content/uploads/2024/03/cropped-VersionImpression.png" alt="Logo de La Puce Ressource Informatique" class="h-16 mx-auto">
            </a>
        </div>
    </footer>

<script>
    function parseMarkdown(text) {
        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\[\[(.*?)\]\]/g, '<code class="bg-slate-200 text-red-600 font-mono py-1 px-2 rounded-md text-sm">[$1]</code>');
        html = html.replace(/\n/g, '<br>');
        return html;
    }
    let loadingInterval;
    let isHistoryExpanded = false;
    const allLoadingMessages = ["Assemblage des idées...", "Préparation de la toile...", "Mélange des couleurs...", "Touche finale du pinceau...", "Votre chef-d'œuvre arrive...", "Démarrage des machines...", "Calibration des circuits...", "Compilation des données...", "Optimisation de l'algorithme...", "Génération du résultat...", "Consultation de la boule de cristal...", "Mélange des potions...", "Invocation des esprits créatifs...", "Saupoudrage de poussière d'étoiles...", "La magie opère..."];
    const SAFETY_INSTRUCTIONS = `\n\nConsignes de sécurité : Ta réponse ne doit contenir aucun contenu violent, haineux, sexuel, discriminatoire, ou offensant. Évite les sujets controversés comme la politique, la guerre, ou la religion. Reste strictement dans un contexte professionnel, amical et sécuritaire.`;
    function savePromptToHistory(promptText) {
        const history = JSON.parse(localStorage.getItem('promptHistory')) || [];
        history.unshift(promptText);
        const limitedHistory = history.slice(0, 20);
        localStorage.setItem('promptHistory', JSON.stringify(limitedHistory));
    }
    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('promptHistory')) || [];
        const historyList = document.getElementById('history-list');
        const seeMoreTrigger = document.getElementById('see-more-trigger');
        const seeMoreText = document.getElementById('see-more-text');
        const promptOutput = document.getElementById('prompt-output');
        const copyBtn = document.getElementById('copy-btn');
        const exportHistoryContainer = document.getElementById('export-history-container');

        historyList.innerHTML = '';

        if (history.length > 0) {
            exportHistoryContainer.classList.remove('hidden');
            const itemsToShow = (isHistoryExpanded || history.length <= 6) ? history : history.slice(0, 6);
            itemsToShow.forEach(promptText => {
                const historyItem = document.createElement('div');
                historyItem.className = 'p-3 bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-sm text-slate-700';
                historyItem.textContent = promptText.substring(0, 100) + (promptText.length > 100 ? '...' : '');
                historyItem.addEventListener('click', () => {
                    promptOutput.innerHTML = parseMarkdown(promptText);
                    promptOutput.classList.remove('hidden');
                    copyBtn.classList.remove('hidden');
                    promptOutput.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                });
                historyList.appendChild(historyItem);
            });
            if (history.length > 6) {
                seeMoreTrigger.classList.remove('hidden');
                seeMoreText.textContent = isHistoryExpanded ? 'Voir moins' : 'Voir plus';
            } else {
                seeMoreTrigger.classList.add('hidden');
            }
        } else {
            exportHistoryContainer.classList.add('hidden');
        }
    }
    function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }
    async function callGeminiAPI(prompt, outputElement, loadingElement, copyBtn) {
        outputElement.innerHTML = '';
        outputElement.classList.add('hidden');
        copyBtn.classList.add('hidden');
        loadingElement.classList.remove('hidden');
        setTimeout(() => loadingElement.classList.add('is-visible'), 10);
        const loadingTextElement = document.getElementById('loading-text');
        const shuffledMessages = shuffle([...allLoadingMessages]);
        let messageIndex = 0;
        loadingTextElement.textContent = shuffledMessages[messageIndex];
        loadingInterval = setInterval(() => {
            messageIndex = (messageIndex + 1) % shuffledMessages.length;
            loadingTextElement.classList.add('is-fading');
            setTimeout(() => {
                loadingTextElement.textContent = shuffledMessages[messageIndex];
                loadingTextElement.classList.remove('is-fading');
            }, 500);
        }, 2000);
        const proxyApiUrl = "https://gemini-proxy-notion.michael-araujo.workers.dev/";
        const payload = {
            prompt: prompt,
            model: 'gemini-2.0-flash-lite'
        };
        try {
            const response = await fetch(proxyApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                if (response.status === 429) {
                    const rateLimitError = new Error("Rate limit exceeded");
                    rateLimitError.isRateLimit = true;
                    throw rateLimitError;
                }
                throw new Error(`Erreur du serveur: ${response.status}`);
            }
            const result = await response.json();
            const text = result?.text;
            if (text) {
                outputElement.innerHTML = parseMarkdown(text);
                outputElement.classList.remove('hidden');
                copyBtn.classList.remove('hidden');
                savePromptToHistory(text);
                renderHistory();
            } else {
                throw new Error("Réponse invalide de l'API");
            }
        } catch (error) {
            console.error(error);
            if (error.isRateLimit) {
                outputElement.innerHTML = "Oups ! Trop de requêtes en même temps, veuillez patienter une minute.";
            } else {
                outputElement.innerHTML = "Désolé, une erreur est survenue. Veuillez réessayer.";
            }
            outputElement.classList.remove('hidden');
        } finally {
            clearInterval(loadingInterval);
            loadingElement.classList.remove('is-visible');
            setTimeout(() => {
                loadingElement.classList.add('hidden');
            }, 400);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const selectContainer = document.getElementById('custom-select-container');
        const selectedDisplay = document.getElementById('select-selected');
        const selectText = document.getElementById('select-text');
        const selectArrow = document.getElementById('select-arrow');
        const optionsContainer = document.getElementById('select-options');
        const customTaskInput = document.getElementById('custom-task-input');
        const generatePromptBtn = document.getElementById('generate-prompt-btn');
        const btnEmoji = document.getElementById('btn-emoji');
        const btnText = document.getElementById('btn-text'); // Référence au texte du bouton
        const promptOutput = document.getElementById('prompt-output');
        const promptLoading = document.getElementById('prompt-loading');
        const copyBtn = document.getElementById('copy-btn');
        const historyTrigger = document.getElementById('history-trigger');
        const historyPanel = document.getElementById('history-panel');
        const seeMoreTrigger = document.getElementById('see-more-trigger');
        const inspireMeBtn = document.getElementById('inspire-me-btn');
        const exportHistoryBtn = document.getElementById('export-history-btn');
        
        let selectedValue = "";
        let promptGenerationCount = 0; // **NOUVEAU** : Compteur de session
        let inspirationClickCount = 0;

        const options = [{
            value: "",
            text: "Sélectionnez une tâche..."
        }, {
            value: "rédiger un courriel de remerciement pour un bénévole",
            text: "Rédiger un courriel de remerciement"
        }, {
            value: "résumer un rapport financier annuel",
            text: "Résumer un rapport financier"
        }, {
            value: "créer un plan de communication pour un événement",
            text: "Créer un plan de communication"
        }, {
            value: "brainstormer des idées de levée de fonds",
            text: "Brainstormer des idées de levée de fonds"
        }, {
            value: "créer une publication pour les réseaux sociaux pour annoncer un événement",
            text: "Créer une publication pour les réseaux sociaux"
        }, {
            value: "rédiger une demande de subvention",
            text: "Rédiger une demande de subvention"
        }, {
            value: "créer un sondage de satisfaction pour les bénévoles",
            text: "Sondage de satisfaction pour les bénévoles"
        }];
        options.forEach(option => {
            const optionEl = document.createElement('div');
            optionEl.textContent = option.text;
            optionEl.dataset.value = option.value;
            optionEl.classList.add('p-3', 'cursor-pointer', 'hover:bg-slate-100');
            if (option.value === "") {
                optionEl.classList.add('text-slate-500');
            }
            optionEl.addEventListener('click', () => {
                selectText.textContent = option.text;
                selectedValue = option.value;
                customTaskInput.value = "";
                closeSelect();
                updateUIState();
            });
            optionsContainer.appendChild(optionEl);
        });
        
        let selectedTone = '';
        let selectedDetail = 'Standard';
        const toneOptions = document.getElementById('tone-options');
        const detailOptions = document.getElementById('detail-options');

        function setupButtonGroup(container, variableSetter) {
            const buttons = container.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    buttons.forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    variableSetter(e.currentTarget.dataset.value);
                });
            });
        }

        setupButtonGroup(toneOptions, (value) => selectedTone = value);
        setupButtonGroup(detailOptions, (value) => selectedDetail = value);
        
        customTaskInput.addEventListener('input', () => {
            if (customTaskInput.value.trim() !== '') {
                selectedValue = "";
                selectText.textContent = "Sélectionnez une tâche...";
            }
            updateUIState();
        });

        function closeSelect() {
            optionsContainer.classList.add('hidden');
            selectArrow.classList.remove('select-arrow-up');
        }
        selectedDisplay.addEventListener('click', (e) => {
            e.stopPropagation();
            optionsContainer.classList.toggle('hidden');
            selectArrow.classList.toggle('select-arrow-up');
        });
        window.addEventListener('click', (e) => {
            if (!selectContainer.contains(e.target)) {
                closeSelect();
            }
        });

        inspireMeBtn.addEventListener('click', async () => {
            if (inspirationClickCount >= 2) {
                return; // Do nothing if the limit is reached
            }

            inspirationClickCount++;
            const originalButtonText = inspireMeBtn.innerHTML;
            inspireMeBtn.disabled = true;
            inspireMeBtn.innerHTML = `<span class="loading-dots" style="font-size: 2rem; line-height: 0.5;"><span>.</span><span>.</span><span>.</span></span>`;

            const inspirationPrompt = `Génère une seule idée de tâche simple et courte pour un employé ou un bénévole d'un organisme à but non lucratif (OBNL) au Québec. La tâche doit être similaire en complexité à "rédiger une demande de subvention" ou "créer une publication pour les réseaux sociaux". Réponds uniquement avec l'intitulé de la tâche, sans aucune phrase d'introduction, formatage (pas de gras, pas d'astérisques), ou ponctuation finale.` + SAFETY_INSTRUCTIONS;

            const proxyApiUrl = "https://gemini-proxy-notion.michael-araujo.workers.dev/";
            const payload = {
                prompt: inspirationPrompt,
                model: 'gemini-2.0-flash-lite'
            };

            try {
                const response = await fetch(proxyApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erreur de l'API: ${response.status}`);
                }

                const result = await response.json();
                let taskText = result?.text?.trim();

                if (taskText) {
                    // Clean up potential markdown or quotes
                    taskText = taskText.replace(/^"|"$|^\*+\s*|\s*\*+$|^\s*-\s*/gm, '');
                    customTaskInput.value = taskText;
                    selectText.textContent = "Sélectionnez une tâche...";
                    selectedValue = "";
                    updateUIState();
                } else {
                    throw new Error("Réponse invalide de l'API");
                }

            } catch (error) {
                console.error("Erreur lors de la génération de l'inspiration:", error);
                customTaskInput.value = "Erreur lors de la génération. Veuillez réessayer.";
            } finally {
                if (inspirationClickCount >= 2) {
                    inspireMeBtn.innerHTML = "Limite atteinte";
                    // The button remains disabled
                } else {
                    inspireMeBtn.disabled = false;
                    inspireMeBtn.innerHTML = originalButtonText;
                }
            }
        });

        function updateUIState() {
            const isTaskSelected = selectedValue !== '';
            const isCustomTaskEntered = customTaskInput.value.trim() !== '';
            generatePromptBtn.disabled = !isTaskSelected && !isCustomTaskEntered;
            if (isTaskSelected || isCustomTaskEntered) {
                btnEmoji.classList.remove('hidden');
            } else {
                btnEmoji.classList.add('hidden');
            }
            if (isTaskSelected) {
                selectedDisplay.classList.add('border-[#010132]', 'border-2');
            } else {
                selectedDisplay.classList.remove('border-[#010132]', 'border-2');
            }
            if (isCustomTaskEntered) {
                customTaskInput.classList.add('border-[#010132]', 'border-2');
            } else {
                customTaskInput.classList.remove('border-[#010132]', 'border-2');
            }
        }

        generatePromptBtn.addEventListener('click', () => {
            const customTaskValue = customTaskInput.value.trim();
            const task = customTaskValue !== '' ? customTaskValue : selectedValue;

            if (task) {
                // **NOUVEAU** : Logique de mise à jour du texte du bouton
                promptGenerationCount++;
                if (promptGenerationCount >= 10) {
                    btnText.textContent = "Encore un autre prompt ?";
                } else if (promptGenerationCount >= 1) {
                    btnText.textContent = "Générer un autre prompt";
                }

                let customizationInstructions = "\n\nInstructions supplémentaires pour le prompt que tu génères :";
                let hasCustomizations = false;
                if (selectedTone) {
                    customizationInstructions += `\n- Le ton doit être : **${selectedTone}**.`;
                    hasCustomizations = true;
                }
                if (selectedDetail) {
                    customizationInstructions += `\n- Le niveau de détail doit être : **${selectedDetail}**.`;
                    hasCustomizations = true;
                }
                
                const prompt = `Ta réponse doit commencer par une phrase d'introduction amicale et contextuelle qui varie à chaque fois. Par exemple : "Voici un prompt que vous pourriez utiliser avec votre agent conversationnel préféré pour la tâche suivante :" ou "Pour vous aider avec la tâche suivante, voici une suggestion de prompt :".

Ensuite, rédige un prompt pour la tâche : "${task}".

Ce prompt doit être adapté au contexte d'un organisme communautaire (OBNL).
${hasCustomizations ? customizationInstructions : ''}

Instructions de formatage pour le prompt que tu génères :
1. Le mot "**Prompt**" doit être en gras (entouré de double astérisques).
2. Les éléments que l'utilisateur doit remplacer par ses propres informations doivent être entre doubles crochets, comme ceci : [[ÉLÉMENT À COMPLÉTER]].` + SAFETY_INSTRUCTIONS;
                callGeminiAPI(prompt, promptOutput, promptLoading, copyBtn);
            }
        });
        
        copyBtn.addEventListener('click', () => {
            const promptText = promptOutput.innerText;
            navigator.clipboard.writeText(promptText).then(() => {
                const originalClasses = ['bg-slate-200', 'hover:bg-slate-300', 'text-slate-600'];
                const successClasses = ['bg-[#49b048]', 'text-white'];
                copyBtn.classList.remove(...originalClasses);
                copyBtn.classList.add(...successClasses);
                copyBtn.textContent = 'Copié !';
                setTimeout(() => {
                    copyBtn.textContent = 'Copier le prompt';
                    copyBtn.classList.remove(...successClasses);
                    copyBtn.classList.add(...originalClasses);
                }, 2000);
            }, (err) => {
                console.error('Could not copy text: ', err);
                copyBtn.textContent = 'Erreur';
            });
        });
        historyTrigger.addEventListener('click', () => {
            document.body.classList.toggle('history-open');
        });
        seeMoreTrigger.addEventListener('click', () => {
            isHistoryExpanded = !isHistoryExpanded;
            historyPanel.classList.toggle('history-expanded');
            renderHistory();
        });

        exportHistoryBtn.addEventListener('click', () => {
            const history = JSON.parse(localStorage.getItem('promptHistory')) || [];
            if (history.length === 0) {
                alert("L'historique est vide. Générez un prompt pour pouvoir l'exporter.");
                return;
            }

            // The history is stored with the newest item first. Reverse it for chronological export.
            const chronologicalHistory = [...history].reverse();

            const fileContent = chronologicalHistory.map((prompt, index) => {
                // The stored prompt is raw text from the API, so no HTML cleaning is needed.
                return `====================\nPROMPT ${index + 1}\n====================\n\n${prompt}`;
            }).join('\n\n\n'); // Use triple newline for more space between entries

            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'idées-prompts-lapuce.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        updateUIState();
        renderHistory();
    });
</script>
</body>
</html>
